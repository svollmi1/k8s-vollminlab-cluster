#!/usr/bin/env groovy

multibranchPipelineJob('k8s-test-deploy') {
    displayName('Kubernetes Test Deployment')

    branchSources {
        github {
            id('k8s-test-deploy')
            repoOwner('svollmi1')
            repository('k8s-vollminlab-cluster')
            scanCredentialsId('github-pat')
        }
    }

    configure { project ->
        // Use github-pat credential for API access
        project / sources / data / 'jenkins.branch.BranchSource' / source / credentialsId('github-pat')

        // Add durability hint
        project / 'properties' / 'org.jenkinsci.plugins.workflow.job.properties.DurabilityHintJobProperty' {
            hint('PERFORMANCE_OPTIMIZED')
        }

        // Add log rotation
        project / 'properties' / 'jenkins.model.BuildDiscarderProperty' {
            strategy {
                'daysToKeep'('30')
                'numToKeep'('10')
                'artifactDaysToKeep'('-1')
                'artifactNumToKeep'('-1')
            }
        }
    }

    // Discover branches
    configure { project ->
        project / sources / data / 'jenkins.branch.BranchSource' / source / traits {
            'org.jenkinsci.plugins.github__branch__source.BranchDiscoveryTrait' {}
            'org.jenkinsci.plugins.github__branch__source.OriginPullRequestDiscoveryTrait' {
                strategyId(1)
            }
            'org.jenkinsci.plugins.github__branch__source.ForkPullRequestDiscoveryTrait' {
                strategyId(1)
                trust(class: 'org.jenkinsci.plugins.github_branch_source.ForkPullRequestDiscoveryTrait$TrustPermission')
            }
        }
    }

    factory {
        workflowBranchProjectFactory {
            scriptPath('clusters/vollminlab-cluster/ci/jenkins-operator/app/cicd/pipelines/k8s.jenkins')
        }
    }

    triggers {
        periodicFolderTrigger {
            interval('1d')
        }
    }

    orphanedItemStrategy {
        discardOldItems {
            numToKeep(20)
        }
    }
}
