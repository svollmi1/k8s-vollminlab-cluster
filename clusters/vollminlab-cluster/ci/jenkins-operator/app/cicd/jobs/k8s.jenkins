#!/usr/bin/env groovy

multibranchPipelineJob('k8s-test-deploy') {
    displayName('Kubernetes Test Deployment')

    branchSources {
        github {
            id('k8s-test-deploy')
            repoOwner('svollmi1')
            repository('k8s-vollminlab-cluster')
            scanCredentialsId('github-pat')
            buildOriginBranch(true)
            buildOriginBranchWithPR(true)
            buildOriginPRMerge(true)
            buildOriginPRHead(false)
            buildForkPRMerge(false)
            buildForkPRHead(false)
        }
    }

    orphanedItemStrategy {
        discardOldItems {
            numToKeep(20)
            daysToKeep(30)
        }
    }

    factory {
        workflowBranchProjectFactory {
            scriptPath('clusters/vollminlab-cluster/ci/jenkins-operator/app/cicd/pipelines/k8s.jenkins')
        }
    }

    configure { project ->
        project / 'sources' / 'data' / 'jenkins.branch.BranchSource' / source / 'traits' << {
            'org.jenkinsci.plugins.github__branch__source.BranchDiscoveryTrait' { strategyId(1) }
            'org.jenkinsci.plugins.github__branch__source.OriginPullRequestDiscoveryTrait' { strategyId(1) }
            'jenkins.plugins.git.traits.CleanBeforeCheckoutTrait' {}
            'jenkins.plugins.git.traits.CleanAfterCheckoutTrait' {}
            'jenkins.plugins.git.traits.LocalBranchTrait' {}
        }
    }
}

