#!/usr/bin/env groovy

def label = "k8s-${UUID.randomUUID().toString()}"
def home = "/home/jenkins"
def workspace = "${home}/workspace"
def testNamespace = "ci-testing"
def branchName = env.BRANCH_NAME ?: 'main'  // Fallback to 'main' if BRANCH_NAME is null

echo "Using branch: ${branchName}"

podTemplate(
    label: label,
    containers: [
        containerTemplate(
            name: 'kubectl-container',
            image: 'lachlanevenson/k8s-kubectl:v1.21.2',
            ttyEnabled: true,
            command: 'sh',
            args: '-c "kubectl version && tail -f /dev/null"',
        ),
        containerTemplate(
            name: 'yamllint-container',
            image: 'cytopia/yamllint:latest',
            ttyEnabled: true,
            command: 'sh',
            args: '-c "yamllint --version && tail -f /dev/null"',
        ),
    ]
) {
    node(label) {
        stage('Checkout Repo') {
            checkout scm
        }

        def files = []
        stage('Get Changed Files') {
            files = sh(script: "git diff --name-only origin/${branchName} HEAD", returnStdout: true).trim().split("\n")
        }

        stage('Parse and Validate YAML') {
            files.each { file ->
                if (file.endsWith(".yaml") || file.endsWith(".yml")) {
                    echo "Validating ${file}"
                    try {
                        container('yamllint-container') {
                            sh "yamllint ${file}"
                        }
                        container('kubectl-container') {
                            sh "kubectl apply --dry-run=client -f ${file} --namespace=${testNamespace}"
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        throw e
                    }
                }
            }
        }

        stage('Apply Resources') {
            try {
                container('kubectl-container') {
                    files.each { file ->
                        if (file.endsWith(".yaml") || file.endsWith(".yml")) {
                            echo "Applying ${file}"
                            sh "kubectl apply -f ${file} --namespace=${testNamespace}"
                        }
                    }
                }
            } catch (Exception e) {
                currentBuild.result = 'FAILURE'
                throw e
            }
        }

        stage('Cleanup') {
            try {
                container('kubectl-container') {
                    files.each { file ->
                        if (file.endsWith(".yaml") || file.endsWith(".yml")) {
                            echo "Cleaning up ${file}"
                            sh "kubectl delete -f ${file} --namespace=${testNamespace}"
                        }
                    }
                }
            } catch (Exception e) {
                currentBuild.result = 'FAILURE'
                throw e
            }
        }
    }
}
