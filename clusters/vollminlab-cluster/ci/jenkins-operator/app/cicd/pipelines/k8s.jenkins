#!/usr/bin/env groovy

def label = "k8s-${UUID.randomUUID().toString()}"
def home = "/home/jenkins"
def workspace = "${home}/workspace/build-jenkins-operator"

podTemplate(label: label,
    containers: [
        containerTemplate(name: 'kubectl', image: 'bitnami/kubectl:latest', ttyEnabled: true, command: 'sh', args: "-c 3600s"),
        containerTemplate(name: 'git', image: 'alpine/git:latest', ttyEnabled: true, command: 'sh', args: "-c sleep 3600s"),
        containerTemplate(name: 'yq', image: 'mikefarah/yq:latest', ttyEnabled: true, command: 'sh', args: "-c sleep 3600s"),
    ],
) {
    node(label) {
        stage('Checkout Code') {
            container('git') {
                checkout scm
            }
        }

        stage('Detect Changed Files') {
            container('git') {
                sh 'git fetch origin main'
                changedFiles = sh(script: "git diff --name-only origin/main", returnStdout: true).trim().split("\n")
                echo "Changed files: ${changedFiles}"
            }
        }

        stage('Lint YAML Files') {
            container('yq') {
                changedFiles.each { file ->
                    if (file.endsWith(".yaml") || file.endsWith(".yml")) {
                        echo "Linting ${file}"
                        sh "yq eval '.' ${workspace}/${file} > /dev/null"
                    }
                }
            }
        }

        stage('Validate and Apply Manifests in ci-testing') {
            container('kubectl') {
                changedFiles.each { file ->
                    if (file.endsWith(".yaml") || file.endsWith(".yml")) {
                        echo "Validating and applying ${file}"
                        sh "kubectl apply --dry-run=client -f ${workspace}/${file} -n ci-testing"
                        sh "kubectl apply -f ${workspace}/${file} -n ci-testing"
                    }
                }
            }
        }

        stage('Cleanup Applied Resources') {
            container('kubectl') {
                changedFiles.each { file ->
                    if (file.endsWith(".yaml") || file.endsWith(".yml")) {
                        echo "Deleting ${file} from ci-testing"
                        sh "kubectl delete -f ${workspace}/${file} -n ci-testing || true"
                    }
                }
            }
        }
    }
}

