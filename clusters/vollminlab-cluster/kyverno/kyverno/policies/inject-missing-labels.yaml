apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: inject-missing-labels
  annotations:
    policies.kyverno.io/title: Inject Missing Required Labels
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/description: "Automatically injects missing app, env, and category labels based on namespace and resource type."
    kyverno.io/enable-background: "true"
  labels:
    app: kyverno
    env: production
    category: security
spec:
  rules:
    # Rule for longhorn-system namespace
    - name: inject-longhorn-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Pod
              namespaces:
                - longhorn-system
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              app: "longhorn"
              env: "production"
              category: "storage"
          spec:
            template:
              metadata:
                labels:
                  app: "longhorn"
                  env: "production"
                  category: "storage"

    # Rule for kyverno namespace
    - name: inject-kyverno-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Pod
              namespaces:
                - kyverno
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              app: "kyverno"
              env: "production"
              category: "security"
          spec:
            template:
              metadata:
                labels:
                  app: "kyverno"
                  env: "production"
                  category: "security"

    # Rule for mediastack namespace
    - name: inject-mediastack-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Pod
              namespaces:
                - mediastack
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              app: "mediastack"
              env: "production"
              category: "media"
          spec:
            template:
              metadata:
                labels:
                  app: "mediastack"
                  env: "production"
                  category: "media"

    # Rule for metallb-system namespace
    - name: inject-metallb-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Pod
              namespaces:
                - metallb-system
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              app: "metallb"
              env: "production"
              category: "networking"
          spec:
            template:
              metadata:
                labels:
                  app: "metallb"
                  env: "production"
                  category: "networking"

    # Rule for sealed-secrets namespace
    - name: inject-sealed-secrets-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Pod
              namespaces:
                - sealed-secrets
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              app: "sealed-secrets"
              env: "production"
              category: "security"
          spec:
            template:
              metadata:
                labels:
                  app: "sealed-secrets"
                  env: "production"
                  category: "security"

    # Rule for actions-runner-system namespace
    - name: inject-actions-runner-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Pod
              namespaces:
                - actions-runner-system
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              app: "actions-runner"
              env: "production"
              category: "ci"
          spec:
            template:
              metadata:
                labels:
                  app: "actions-runner"
                  env: "production"
                  category: "ci"

    # Rule for cert-manager namespace
    - name: inject-cert-manager-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Pod
              namespaces:
                - cert-manager
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              app: "cert-manager"
              env: "production"
              category: "security"
          spec:
            template:
              metadata:
                labels:
                  app: "cert-manager"
                  env: "production"
                  category: "security"

    # Rule for ingress-nginx namespace
    - name: inject-ingress-nginx-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Pod
              namespaces:
                - ingress-nginx
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              app: "ingress-nginx"
              env: "production"
              category: "networking"
          spec:
            template:
              metadata:
                labels:
                  app: "ingress-nginx"
                  env: "production"
                  category: "networking"

    # Rule for portainer namespace
    - name: inject-portainer-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Pod
              namespaces:
                - portainer
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              app: "portainer"
              env: "production"
              category: "management"
          spec:
            template:
              metadata:
                labels:
                  app: "portainer"
                  env: "production"
                  category: "management"

    # Rule for homepage namespace
    - name: inject-homepage-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Pod
              namespaces:
                - homepage
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              app: "homepage"
              env: "production"
              category: "dashboard"
          spec:
            template:
              metadata:
                labels:
                  app: "homepage"
                  env: "production"
                  category: "dashboard"

    # Rule for elastic-system namespace
    - name: inject-elastic-labels
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Pod
              namespaces:
                - elastic-system
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              app: "elastic"
              env: "production"
              category: "monitoring"
          spec:
            template:
              metadata:
                labels:
                  app: "elastic"
                  env: "production"
                  category: "monitoring"
