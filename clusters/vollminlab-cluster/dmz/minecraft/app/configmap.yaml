apiVersion: v1
kind: ConfigMap
metadata:
  name: minecraft-values
  namespace: dmz
  labels:
    app: minecraft
    env: production
    category: gaming
data:
  values.yaml: |
    image:
      repository: itzg/minecraft-server
      tag: "java21"
    resources:
      requests:
        cpu: 2000m
        memory: 6Gi
      limits:
        cpu: 4000m
        memory: 8Gi
    nodeSelector:
      node-role.kubernetes.io/dmz: "true"
    tolerations:
      - key: "dmz"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
    podLabels:
      app: minecraft
      env: production
      category: gaming
    podSecurityContext:
      runAsNonRoot: true
      fsGroup: 1000
      fsGroupChangePolicy: "OnRootMismatch"
      seccompProfile:
        type: RuntimeDefault
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
      seccompProfile:
        type: RuntimeDefault
    persistence:
      dataDir:
        enabled: true
        existingClaim: pvc-minecraft-datadir
      storageClass: longhorn-dmz
    minecraftServer:
      eula: "TRUE"
      version: "1.21.10"
      type: "PAPER"
      memory: "6G"
      viewDistance: 8
      maxPlayers: 20
      difficulty: normal
      serviceType: NodePort
      nodePort: 32565
      externalTrafficPolicy: Local
      # Set maxWorldSize to prevent duplicate MAX_WORLD_SIZE env var in Helm deployment
      # NOTE: This sets the env var, but server.properties must be manually set to 29999984
      # The server.properties file is in a PVC and persists across restarts
      # Manual fix applied: max-world-size=29999984 in /data/server.properties
      maxWorldSize: 29999984
      rcon:
        enabled: true
        # Password is now stored in SealedSecret and passed via environment variable
    extraEnv:
      SIMULATION_DISTANCE: "6"
      PLUGINS: "https://cdn.modrinth.com/data/swbUV1cr/versions/lfk408pd/bluemap-5.13-spigot.jar"
    # RCON password from secret (itzg/minecraft-server supports RCON_PASSWORD env var)
    # Note: The Helm chart may need extraEnvVars or envFrom instead - check chart docs
    extraEnvVars:
      - name: RCON_PASSWORD
        valueFrom:
          secretKeyRef:
            name: minecraft-rcon-secret
            key: password
    readinessProbe:
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 10
      successThreshold: 1
      timeoutSeconds: 1
    livenessProbe:
      initialDelaySeconds: 30
      periodSeconds: 5
      failureThreshold: 10
      successThreshold: 1
      timeoutSeconds: 1
